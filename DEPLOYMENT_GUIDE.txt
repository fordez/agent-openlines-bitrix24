================================================================================
GUÍA DE DESPLIEGUE — BOT VIAJES (LOCAL & PRODUCCIÓN)
================================================================================

Este documento detalla cómo probar el bot localmente y cómo llevarlo a producción
usando Fly.io con su servicio de Redis integrado.

--------------------------------------------------------------------------------
1. PRUEBA LOCAL (DOCKER + NGROK)
--------------------------------------------------------------------------------

Prerequisitos: Docker Desktop, Ngrok instalado.

PASO 1: Levantar servicios
   $ docker compose up -d --build

PASO 2: Abrir túnel Ngrok (si no está corriendo)
   $ ngrok http 8080

PASO 3: Configurar Bitrix24
   Copia la URL de ngrok (ej. https://xxxx.ngrok-free.app) y pégala en 
   la configuración de tu aplicación/webhook en Bitrix24.

PASO 4: Monitorear logs
   $ docker compose logs -f bot

--------------------------------------------------------------------------------
2. DESPLIEGUE EN PRODUCCIÓN (FLY.IO)
--------------------------------------------------------------------------------

Prerequisitos: flyctl (Fly CLI) instalado y cuenta activa.

PASO 1: Iniciar el proyecto en Fly.io
   $ fly launch
   - Di que NO a la base de datos Postgres (usaremos Redis).
   - Di que SÍ al despliegue inicial (aunque fallará hasta configurar secretos).

PASO 2: Crear base de datos Redis en Fly.io (Upstash)
   $ fly redis create
   - Nombre: bot-viajes-redis
   - Organización: (tu organización)
   - Región: (la misma que el bot, ej. bog o mia)
   - Plan: Free o el que prefieras.

PASO 3: Obtener la URL de Redis
   Una vez creado, Fly te dará una URL (REDIS_URL). Si no la tienes, búscala:
   $ fly redis status bot-viajes-redis --private

PASO 4: Configurar los Secretos (.env en la nube)
   $ fly secrets set \
     BITRIX_DOMAIN=tu_dominio.bitrix24.com \
     CLIENT_ID=tu_id \
     CLIENT_SECRET=tu_secret \
     ACCESS_TOKEN=xxx \
     REFRESH_TOKEN=xxx \
     GOOGLE_API_KEY=tu_google_key \
     LLM_PROVIDER=google \
     REDIS_URL=redis://default:password@tu-host-redis:6379/0

   NOTA: Asegúrate de usar la URL privada de Redis que te dio Fly en el paso anterior.

PASO 5: Archivos de configuración MCP
   Asegúrate de que 'mcp_agent.config.yaml' y 'mcp_agent.secrets.yaml' estén 
   en el repositorio Git (o manéjalos como secrets de Fly si son sensibles).
   El Dockerfile actual los COPIA directamente al contenedor.

PASO 6: Desplegar
   $ fly deploy

PASO 7: Configurar Bitrix24 Producción
   Usa la URL permanente de Fly (ej. https://bot-viajes.fly.dev) para 
   apuntar los webhooks de producción.

--------------------------------------------------------------------------------
3. MANTENIMIENTO ÚTIL
--------------------------------------------------------------------------------

- Ver logs en vivo:
  $ fly logs

- SSH al contenedor (para depurar):
  $ fly ssh console

- Escalar memoria (si el LLM o agentes consumen mucho):
  $ fly scale memory 512
================================================================================
